package project;

import javax.swing.*;
import javax.swing.border.*;
import java.awt.*;
import java.time.LocalDate;
import java.util.LinkedHashMap;
import java.util.Map;

class HealthcarePanel extends JPanel {
    private SchedulerApp parent;
    private MainPanel mainPanel;

    private JTextField foodField;
    private JTextField sleepField;

    // 운동 선택(표 반영) + 시간 입력
    private JComboBox<String> exerciseCombo;
    private JTextField exerciseTimeField;

    private JButton backBtn;
    private JLabel characterLabel;

    // 기본 신체 정보 (MainPanel에서 BMR 계산에 사용)
    private static double weight = 70;
    private static double height = 175;
    private static int age = 25;

    // 1시간당 소모 칼로리 표 (준모님 제공)
    // 단일 값은 min=max, 범위(~)는 min~max로 저장하며 계산 시 '중간값'을 사용합니다.
    private static final Map<String, int[]> EXERCISE_PER_HOUR = new LinkedHashMap<>();
    static {
        EXERCISE_PER_HOUR.put("체조", new int[]{180, 180});
        EXERCISE_PER_HOUR.put("빨래", new int[]{180, 180});
        EXERCISE_PER_HOUR.put("걷기 (5.6km/시간)", new int[]{240, 300});
        EXERCISE_PER_HOUR.put("볼링", new int[]{240, 300});
        EXERCISE_PER_HOUR.put("설거지", new int[]{270, 270});
        EXERCISE_PER_HOUR.put("에어로빅", new int[]{300, 360});
        EXERCISE_PER_HOUR.put("테니스(복식)", new int[]{300, 420});
        EXERCISE_PER_HOUR.put("스케이팅 (6.4km/시간)", new int[]{360, 480});
        EXERCISE_PER_HOUR.put("테니스(단식)", new int[]{420, 600});
        EXERCISE_PER_HOUR.put("수영", new int[]{720, 720});
        EXERCISE_PER_HOUR.put("등산", new int[]{780, 780});
        EXERCISE_PER_HOUR.put("달리기 (9km/시간)", new int[]{600, 660});
    }

    public HealthcarePanel(SchedulerApp parent, MainPanel mainPanel) {
        this.parent = parent;
        this.mainPanel = mainPanel;

        setLayout(new BorderLayout(12, 12));
        setBorder(new EmptyBorder(20, 20, 20, 20));

        JLabel title = new JLabel("헬스케어 관리", SwingConstants.CENTER);
        title.setFont(new Font("SansSerif", Font.BOLD, 22));
        add(title, BorderLayout.NORTH);

        JPanel center = new JPanel(new GridLayout(4, 2, 12, 12));
        center.setBorder(new TitledBorder("입력"));

        // 캐릭터 정보
        characterLabel = new JLabel("", SwingConstants.CENTER);
        characterLabel.setFont(new Font("SansSerif", Font.PLAIN, 16));
        add(characterLabel, BorderLayout.WEST);

        // 음식 칼로리 입력
        center.add(new JLabel("음식 칼로리 (kcal):"));
        foodField = new JTextField();
        center.add(foodField);
        JButton foodBtn = new JButton("입력");
        center.add(foodBtn);
        center.add(new JLabel(""));

        // 운동: 표 선택 + 시간(분)
        center.add(new JLabel("운동 종류 (1시간당 소모 칼로리 표):"));
        exerciseCombo = new JComboBox<>(EXERCISE_PER_HOUR.keySet().toArray(new String[0]));
        center.add(exerciseCombo);

        center.add(new JLabel("운동 시간 (분):"));
        exerciseTimeField = new JTextField();
        center.add(exerciseTimeField);
        JButton exerciseBtn = new JButton("운동 입력");
        center.add(exerciseBtn);
        center.add(new JLabel(""));

        // 수면 입력
        center.add(new JLabel("수면 시간 (시간):"));
        sleepField = new JTextField();
        center.add(sleepField);
        JButton sleepBtn = new JButton("입력");
        center.add(sleepBtn);
        center.add(new JLabel(""));

        add(center, BorderLayout.CENTER);

        backBtn = new JButton("뒤로가기");
        add(backBtn, BorderLayout.SOUTH);

        // 음식 입력 이벤트
        foodBtn.addActionListener(e -> {
            try {
                int kcal = Integer.parseInt(foodField.getText().trim());
                mainPanel.addFoodCalories(LocalDate.now(), kcal);
                JOptionPane.showMessageDialog(this, "음식 칼로리 입력 완료!");
                foodField.setText("");
            } catch (NumberFormatException ex) {
                JOptionPane.showMessageDialog(this, "숫자를 입력해주세요.");
            }
        });

        // 운동 입력 이벤트 (범위가 있으면 '중간값' 사용)
        exerciseBtn.addActionListener(e -> {
            try {
                String type = (String) exerciseCombo.getSelectedItem();
                if (type == null || type.isEmpty()) {
                    JOptionPane.showMessageDialog(this, "운동 종류를 선택해주세요.");
                    return;
                }
                int[] range = EXERCISE_PER_HOUR.get(type);
                if (range == null || range.length != 2) {
                    JOptionPane.showMessageDialog(this, "운동 표 데이터가 올바르지 않습니다.");
                    return;
                }
                int minutes = Integer.parseInt(exerciseTimeField.getText().trim());
                if (minutes <= 0) {
                    JOptionPane.showMessageDialog(this, "운동 시간(분)을 1 이상으로 입력해주세요.");
                    return;
                }

                // 중간값(범위면 (min+max)/2, 단일값이면 해당 값)
                int perHour = (range[0] + range[1]) / 2;
                int kcal = perHour * minutes / 60;

                mainPanel.addExerciseCalories(LocalDate.now(), kcal);
                JOptionPane.showMessageDialog(
                    this,
                    type + " " + minutes + "분 입력 완료! (" + kcal + " kcal, 기준: " + perHour + " kcal/시간)"
                );
                exerciseTimeField.setText("");
            } catch (NumberFormatException ex) {
                JOptionPane.showMessageDialog(this, "운동 시간을 숫자로 입력해주세요.");
            }
        });

        // 수면 입력 이벤트
        sleepBtn.addActionListener(e -> {
            try {
                int hours = Integer.parseInt(sleepField.getText().trim());
                if (hours <= 0) {
                    JOptionPane.showMessageDialog(this, "수면 시간(시간)을 1 이상으로 입력해주세요.");
                    return;
                }
                mainPanel.addSleepHours(LocalDate.now(), hours);
                JOptionPane.showMessageDialog(this, "수면 입력 완료!");
                sleepField.setText("");
            } catch (NumberFormatException ex) {
                JOptionPane.showMessageDialog(this, "숫자를 입력해주세요.");
            }
        });
    }

    public JButton getBackButton() { return backBtn; }

    public void setCharacterText(String text) {
        characterLabel.setText("캐릭터: " + text);
    }

    // 기본 신체 정보 getter (MainPanel에서 사용)
    public static double getWeight() { return weight; }
    public static double getHeight() { return height; }
    public static int getAge() { return age; }
}