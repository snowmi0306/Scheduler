package project;

import javax.swing.*;
import javax.swing.border.*;
import java.awt.*;
import java.time.*;
import java.time.format.DateTimeFormatter;
import java.util.*;

public class MyCharacter {
    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> new SchedulerApp().setVisible(true));
    }
}

class SchedulerApp extends JFrame {
    private CardLayout cardLayout;
    private JPanel cards;
    private RegistrationPanel registrationPanel;
    private MainPanel mainPanel;
    private HealthcarePanel healthcarePanel;
    private int userId;

    public SchedulerApp() {
        setTitle("ìŠ¤ì¼€ì¤„ëŸ¬ / ìºë¦­í„°");
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setSize(880, 640);
        setLocationRelativeTo(null);

        cardLayout = new CardLayout();
        cards = new JPanel(cardLayout);

        registrationPanel = new RegistrationPanel(this);
        mainPanel = new MainPanel(this);
        healthcarePanel = new HealthcarePanel(this);

        cards.add(registrationPanel, "register");
        cards.add(mainPanel, "main");
        cards.add(healthcarePanel, "healthcare");

        add(cards);
        cardLayout.show(cards, "register");

        // MainPanel â†’ HealthcarePanel ì´ë™
        mainPanel.getHealthcareButton().addActionListener(e -> {
            healthcarePanel.setCharacterText(mainPanel.getNickname() + " " + mainPanel.getAvatarIcon());
            cardLayout.show(cards, "healthcare");
        });

        // HealthcarePanel â†’ MainPanel ì´ë™
        healthcarePanel.getBackButton().addActionListener(e -> cardLayout.show(cards, "main"));
    }

    public void showMain(String nickname, String avatarIcon) {
        userId = DBManager.insertUser(nickname, avatarIcon);
        mainPanel.setUserInfo(nickname, avatarIcon);
        cardLayout.show(cards, "main");
    }

    public int getUserId() { return userId; }
}

class RegistrationPanel extends JPanel {
    private SchedulerApp parent;
    private JComboBox<String> avatarCombo;
    private JTextField nameField;

    public RegistrationPanel(SchedulerApp parent) {
        this.parent = parent;
        setLayout(new BorderLayout(10, 10));
        setBorder(new EmptyBorder(40, 80, 40, 80));

        JLabel title = new JLabel("ìºë¦­í„° ìƒì„±", SwingConstants.CENTER);
        title.setFont(new Font("SansSerif", Font.BOLD, 26));
        add(title, BorderLayout.NORTH);

        JPanel center = new JPanel(new BorderLayout(10, 10));
        JLabel preview = new JLabel("ğŸŒ", SwingConstants.CENTER);
        preview.setFont(new Font("SansSerif", Font.PLAIN, 48));
        preview.setBorder(new LineBorder(Color.LIGHT_GRAY, 1));
        preview.setPreferredSize(new Dimension(180, 180));
        center.add(preview, BorderLayout.WEST);

        JPanel form = new JPanel(new GridLayout(4, 1, 8, 8));
        form.setBorder(new EmptyBorder(10, 20, 10, 20));
        avatarCombo = new JComboBox<>(new String[]{"ğŸŒ í•´ë‹˜", "ğŸŒ™ ë‹¬ë‹˜", "â­ ë³„ë‹˜", "ğŸ¶ ê°•ì•„ì§€", "ğŸ± ê³ ì–‘ì´"});
        nameField = new JTextField();

        avatarCombo.addActionListener(e -> {
            String sel = (String) avatarCombo.getSelectedItem();
            preview.setText(sel.split(" ")[0]);
        });

        form.add(new JLabel("ì•„ë°”íƒ€ ì„ íƒ"));
        form.add(avatarCombo);
        form.add(new JLabel("ë‹‰ë„¤ì„ ì…ë ¥"));
        form.add(nameField);

        center.add(form, BorderLayout.CENTER);
        add(center, BorderLayout.CENTER);

        JButton createBtn = new JButton("ë“±ë¡ ì™„ë£Œ");
        createBtn.setFont(new Font("SansSerif", Font.BOLD, 14));
        createBtn.addActionListener(e -> {
            String name = nameField.getText().trim();
            String avatar = (String) avatarCombo.getSelectedItem();
            if (name.isEmpty()) {
                JOptionPane.showMessageDialog(this, "ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            parent.showMain(name, avatar);
        });
        add(createBtn, BorderLayout.SOUTH);
    }
}

class MainPanel extends JPanel {
    private String nickname = "ì‚¬ìš©ì";
    private String avatarIcon = "ğŸŒ";
    private JLabel avatarLabel;
    private JLabel nameLabel;
    private JProgressBar hpBar;
    private JLabel dateLabel;
    private JLabel timeLabel;
    private JComboBox<LocalDate> dateSelector;
    private DefaultListModel<String> scheduleModel;
    private JList<String> scheduleList;
    private Map<LocalDate, TreeMap<LocalTime, String>> scheduleStore = new HashMap<>();
    private JTextField timeInput;
    private JTextField taskInput;
    private JPanel regCard;
    private JButton healthcareBtn;
    private SchedulerApp parent;

    public MainPanel(SchedulerApp parent) {
        this.parent = parent;
        setLayout(new BorderLayout(12, 12));
        setBorder(new EmptyBorder(12, 12, 12, 12));

        // ìºë¦­í„° ì¹´ë“œ
        JPanel charCard = new JPanel(new BorderLayout());
        charCard.setBorder(new TitledBorder("ìºë¦­í„°"));
        avatarLabel = new JLabel(avatarIcon, SwingConstants.CENTER);
        avatarLabel.setFont(new Font("SansSerif", Font.PLAIN, 48));
        nameLabel = new JLabel("ë‹‰ë„¤ì„: " + nickname, SwingConstants.CENTER);
        charCard.add(avatarLabel, BorderLayout.CENTER);
        charCard.add(nameLabel, BorderLayout.SOUTH);

        // HP ìƒíƒœ
        hpBar = new JProgressBar(0, 100);
        hpBar.setValue(100);
        hpBar.setStringPainted(true);

        // ë‚ ì§œ/ì‹œê°„
        dateLabel = new JLabel("ë‚ ì§œ: " + LocalDate.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd")), SwingConstants.CENTER);
        timeLabel = new JLabel("ì‹œê°„: " + LocalTime.now().format(DateTimeFormatter.ofPattern("HH:mm:ss")), SwingConstants.CENTER);

        JPanel top = new JPanel(new GridLayout(1,3));
        top.add(charCard);
        top.add(dateLabel);
        top.add(hpBar);
        add(top, BorderLayout.NORTH);

        // ì¼ì • ëª©ë¡
        scheduleModel = new DefaultListModel<>();
        scheduleList = new JList<>(scheduleModel);
        add(new JScrollPane(scheduleList), BorderLayout.CENTER);

        // í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜
        healthcareBtn = new JButton("í—¬ìŠ¤ì¼€ì–´");
        JButton schedulerBtn = new JButton("ìŠ¤ì¼€ì¤„ëŸ¬");
        JButton shopBtn = new JButton("ìƒì ");
        JPanel nav = new JPanel(new GridLayout(1,3));
        nav.add(healthcareBtn);
        nav.add(schedulerBtn);
        nav.add(shopBtn);
        add(nav, BorderLayout.SOUTH);

        // ì™„ë£Œ/ì‹¤íŒ¨ ë²„íŠ¼ HP ë°˜ì˜
        JButton completeBtn = new JButton("âœ… ì™„ë£Œ");
        JButton failBtn = new JButton("âŒ ì‹¤íŒ¨");
        JPanel actionPanel = new JPanel();
        actionPanel.add(completeBtn);
        actionPanel.add(failBtn);
        add(actionPanel, BorderLayout.EAST);

        completeBtn.addActionListener(e -> {
            hpBar.setValue(Math.min(100, hpBar.getValue() + 10));
            DBManager.updateHP(parent.getUserId(), hpBar.getValue());
        });

        failBtn.addActionListener(e -> {
            hpBar.setValue(Math.max(0, hpBar.getValue() - 10));
            DBManager.updateHP(parent.getUserId(), hpBar.getValue());
        });

        // ì‹œê³„ íƒ€ì´ë¨¸
        new javax.swing.Timer(1000, e -> {
            timeLabel.setText("ì‹œê°„: " + LocalTime.now().format(DateTimeFormatter.ofPattern("HH:mm:ss")));
            dateLabel.setText("ë‚ ì§œ: " + LocalDate.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd")));
        }).start();
    }

    public void setUserInfo(String nickname, String avatarIcon) {
        this.nickname = nickname;
        this.avatarIcon = avatarIcon.split(" ")[0];
        avatarLabel.setText(this.avatarIcon);
        nameLabel.setText("ë‹‰ë„¤ì„: " + this.nickname);
    }

    public JButton getHealthcareButton() { return healthcareBtn; }
    public String getNickname() { return nickname; }
    public String getAvatarIcon() { return avatarIcon; }
}

