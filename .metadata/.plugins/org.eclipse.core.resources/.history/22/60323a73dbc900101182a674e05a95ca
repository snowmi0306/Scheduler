package project;

import javax.swing.*;
import javax.swing.border.*;
import java.awt.*;
import java.awt.event.*;
import java.time.*;
import java.time.format.DateTimeFormatter;
import java.util.*;

class MainPanel extends JPanel {
    private String nickname = "사용자";
    private String avatarIcon = "여자1";

    private JLabel avatarLabel;
    private JLabel nameLabel;
    private JProgressBar hpBar;
    private JLabel dateLabel;
    private JLabel timeLabel;
    private JComboBox<LocalDate> dateSelector;

    private DefaultListModel<String> scheduleModel;
    private JList<String> scheduleList;
    private Map<LocalDate, TreeMap<LocalTime, String>> scheduleStore = new HashMap<>();

    private JTextField timeInput;
    private JTextField taskInput;
    private JPanel regCard;

    private JButton healthcareBtn;

    private Map<LocalDate, Integer> foodCalories = new HashMap<>();
    private Map<LocalDate, Integer> exerciseCalories = new HashMap<>();

    public MainPanel() {
        setLayout(new BorderLayout(12, 12));
        setBorder(new EmptyBorder(12, 12, 12, 12));

        JPanel top = new JPanel(new BorderLayout(8, 8));
        top.setPreferredSize(new Dimension(0, 120));

        JPanel charCard = new JPanel(new BorderLayout());
        charCard.setBorder(new TitledBorder("캐릭터"));
        avatarLabel = new JLabel(avatarIcon, SwingConstants.CENTER);
        avatarLabel.setFont(new Font("SansSerif", Font.PLAIN, 32));
        nameLabel = new JLabel("닉네임: " + nickname, SwingConstants.CENTER);
        nameLabel.setFont(new Font("SansSerif", Font.BOLD, 14));
        charCard.add(avatarLabel, BorderLayout.CENTER);
        charCard.add(nameLabel, BorderLayout.SOUTH);
        charCard.setPreferredSize(new Dimension(220, 0));
        top.add(charCard, BorderLayout.WEST);

        JPanel centerCard = new JPanel(new BorderLayout(6, 6));
        centerCard.setBorder(new TitledBorder("날짜 및 시간"));
        JPanel dtPanel = new JPanel(new GridLayout(2, 1));
        dateLabel = new JLabel("날짜: " + LocalDate.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd")), SwingConstants.CENTER);
        dateLabel.setFont(new Font("SansSerif", Font.PLAIN, 16));
        timeLabel = new JLabel("시간: " + LocalTime.now().format(DateTimeFormatter.ofPattern("HH:mm:ss")), SwingConstants.CENTER);
        timeLabel.setFont(new Font("SansSerif", Font.PLAIN, 16));
        dtPanel.add(dateLabel);
        dtPanel.add(timeLabel);
        centerCard.add(dtPanel, BorderLayout.CENTER);

        LocalDate today = LocalDate.now();
        dateSelector = new JComboBox<>();
        for (int i = -30; i <= 30; i++) {
            dateSelector.addItem(today.plusDays(i));
        }
        dateSelector.setSelectedItem(today);
        dateSelector.addActionListener(e -> loadSchedulesForSelectedDate());
        JPanel selPanel = new JPanel(new FlowLayout(FlowLayout.CENTER));
        selPanel.add(new JLabel("날짜 선택:"));
        selPanel.add(dateSelector);
        centerCard.add(selPanel, BorderLayout.SOUTH);

        top.add(centerCard, BorderLayout.CENTER);

        JPanel statusCard = new JPanel();
        statusCard.setLayout(new BoxLayout(statusCard, BoxLayout.Y_AXIS));
        statusCard.setBorder(new TitledBorder("상태"));
        hpBar = new JProgressBar(0, 100);
        hpBar.setValue(100);
        hpBar.setStringPainted(true);
        hpBar.setForeground(Color.RED);
        JLabel hpLabel = new JLabel("HP", SwingConstants.CENTER);
        hpLabel.setAlignmentX(Component.CENTER_ALIGNMENT);
        statusCard.add(hpLabel);
        statusCard.add(Box.createRigidArea(new Dimension(0, 6)));
        statusCard.add(hpBar);
        statusCard.setPreferredSize(new Dimension(220, 0));
        top.add(statusCard, BorderLayout.EAST);

        add(top, BorderLayout.NORTH);

        // 일정 목록
        scheduleModel = new DefaultListModel<>();
        scheduleList = new JList<>(scheduleModel);
        scheduleList.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
        scheduleList.setFont(new Font("SansSerif", Font.PLAIN, 14));
        JScrollPane scroll = new JScrollPane(scheduleList);
        scroll.setBorder(new TitledBorder("일정 목록"));
        add(scroll, BorderLayout.CENTER);

        // 하단
        JPanel bottom = new JPanel(new BorderLayout(8, 8));
        regCard = new JPanel(new BorderLayout(6, 6));
        regCard.setBorder(new TitledBorder("일정 등록"));
        regCard.setVisible(false);
        JPanel fields = new JPanel(new GridLayout(2, 2, 6, 6));
        fields.add(new JLabel("시간 (HH:mm):"));
        timeInput = new JTextField();
        fields.add(timeInput);
        fields.add(new JLabel("내용:"));
        taskInput = new JTextField();
        fields.add(taskInput);
        regCard.add(fields, BorderLayout.CENTER);
        JButton addBtn = new JButton("등록");
        regCard.add(addBtn, BorderLayout.EAST);

        bottom.add(regCard, BorderLayout.CENTER);

        JPanel nav = new JPanel(new GridLayout(1, 3, 12, 12));
        nav.setBorder(new EmptyBorder(6, 6, 6, 6));
        healthcareBtn = new JButton("헬스케어");
        JButton schedulerBtn = new JButton("스케줄러");
        JButton shopBtn = new JButton("상점");
        nav.add(healthcareBtn);
        nav.add(schedulerBtn);
        nav.add(shopBtn);
        bottom.add(nav, BorderLayout.SOUTH);

        add(bottom, BorderLayout.SOUTH);

        // 일정 등록 버튼 이벤트
        addBtn.addActionListener(e -> {
            LocalDate selectedDate = (LocalDate) dateSelector.getSelectedItem();
            String t = timeInput.getText().trim();
            String task = taskInput.getText().trim();
            if (t.isEmpty() || task.isEmpty()) {
                JOptionPane.showMessageDialog(this, "시간과 내용을 모두 입력해주세요.");
                return;
            }
            try {
                LocalTime lt = LocalTime.parse(t, DateTimeFormatter.ofPattern("HH:mm"));
                scheduleStore.putIfAbsent(selectedDate, new TreeMap<>());
                scheduleStore.get(selectedDate).put(lt, task + " [미완료]");
                loadSchedulesForSelectedDate();
                timeInput.setText("");
                taskInput.setText("");
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "시간 형식이 올바르지 않습니다. 예: 14:00");
            }
        });

        // 스케줄러 버튼: 등록 카드 토글
        schedulerBtn.addActionListener(e -> regCard.setVisible(!regCard.isVisible()));
        shopBtn.addActionListener(e -> JOptionPane.showMessageDialog(this, "상점으로 이동합니다."));

        // 시간 라벨 갱신 타이머
        new javax.swing.Timer(1000, e -> {
            timeLabel.setText("시간: " + LocalTime.now().format(DateTimeFormatter.ofPattern("HH:mm:ss")));
            dateLabel.setText("날짜: " + LocalDate.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd")));
        }).start();

        loadSchedulesForSelectedDate();
    }

    public void setUserInfo(String nickname, String avatarIcon) {
        this.nickname = nickname;
        this.avatarIcon = avatarIcon;
        avatarLabel.setText(this.avatarIcon);
        nameLabel.setText("닉네임: " + this.nickname);
    }

    private void loadSchedulesForSelectedDate() {
        LocalDate selectedDate = (LocalDate) dateSelector.getSelectedItem();
        scheduleModel.clear();
        TreeMap<LocalTime, String> map = scheduleStore.getOrDefault(selectedDate, new TreeMap<>());
        for (Map.Entry<LocalTime, String> e : map.entrySet()) {
            scheduleModel.addElement(e.getKey().format(DateTimeFormatter.ofPattern("HH:mm")) + " - " + e.getValue());
        }
    }

    // 헬스케어 관련 메서드 추가
    public JButton getHealthcareButton() { return healthcareBtn; }
    public String getNickname() { return nickname; }
    public String getAvatarIcon() { return avatarIcon; }

    public void addFoodCalories(LocalDate date, int kcal) {
        foodCalories.put(date, foodCalories.getOrDefault(date, 0) + kcal);
        checkDailyBalance(date);
    }

    public void addExerciseCalories(LocalDate date, int kcal) {
        exerciseCalories.put(date, exerciseCalories.getOrDefault(date, 0) + kcal);
        checkDailyBalance(date);
    }

    private void checkDailyBalance(LocalDate date) {
        int food = foodCalories.getOrDefault(date, 0);
        int exercise = exerciseCalories.getOrDefault(date, 0);

        boolean isMale = avatarIcon.startsWith("남자");
        double weight = HealthcarePanel.getWeight();
        double height = HealthcarePanel.getHeight();
        int age = HealthcarePanel.getAge();

        int bmr = calculateBMR(isMale, weight, height, age);
        int allowed = bmr + exercise;

        if (food > allowed) {
            int excess = food - allowed;
            int hpLoss = excess / 200 * 10;
            hpBar.setValue(Math.max(0, hpBar.getValue() - hpLoss));
            JOptionPane.showMessageDialog(this, "칼로리 초과! HP -" + hpLoss);
        }
    }

    public static int calculateBMR(boolean isMale, double weight, double height, int age) {
        if (isMale) {
            return (int)Math.round(66.47 + (13.75 * weight) + (5 * height) - (6.76 * age));
        } else {
            return (int)Math.round(655.1 + (9.56 * weight) + (1.85 * height) - (4.68 * age));
        }
    }
}