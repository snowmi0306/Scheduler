package project;

import java.sql.*;
import java.nio.file.*;
import java.util.*;

public class DBManager {
    private static final String DB_URL = "jdbc:sqlite:health_scheduler.db";

    static {
        try {
            Class.forName("org.sqlite.JDBC");
            System.out.println("SQLite JDBC Driver Loaded");
            initDatabase();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static Connection getConnection() throws SQLException {
        return DriverManager.getConnection(DB_URL);
    }

    private static void initDatabase() {
        List<Path> possiblePaths = List.of(
            Paths.get("health_scheduler.sql"),
            Paths.get("src/health_scheduler.sql"),
            Paths.get("src/project/health_scheduler.sql")
        );

        Path sqlPath = null;
        for (Path path : possiblePaths) {
            if (Files.exists(path)) {
                sqlPath = path;
                break;
            }
        }

        if (sqlPath == null) {
            System.err.println("SQL 파일을 찾을 수 없습니다. 다음 위치 중 하나에 있어야 합니다:");
            System.err.println(" - 프로젝트 루트: health_scheduler.sql");
            System.err.println(" - src 폴더: src/health_scheduler.sql");
            System.err.println(" - src/project 폴더: src/project/health_scheduler.sql");
            return;
        }

        try (Connection conn = getConnection();
             Statement stmt = conn.createStatement()) {

            String content = Files.readString(sqlPath);
            String[] commands = content.split(";");

            for (String cmd : commands) {
                cmd = cmd.trim();
                if (cmd.isEmpty() || cmd.startsWith("--")) continue;
                stmt.execute(cmd);
            }

            System.out.println("SQL 파일 실행 완료: " + sqlPath.toString());

        } catch (Exception e) {
            System.err.println("DB 초기화 실패: " + e.getMessage());
            e.printStackTrace();
        }
    }

    public static int insertUser(String nickname, String character) {
        String sql = "INSERT INTO user(nickname, character, hp, coin) VALUES(?,?,100,0)";
        try (Connection conn = getConnection();
             PreparedStatement ps = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {
            ps.setString(1, nickname);
            ps.setString(2, character);
            ps.executeUpdate();
            ResultSet rs = ps.getGeneratedKeys();
            if (rs.next()) return rs.getInt(1);
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return -1;
    }

    public static void updateWeight(int userId, double weight) {
        String sql = "UPDATE user SET weight=? WHERE id=?";
        try (Connection conn = getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {
            ps.setDouble(1, weight);
            ps.setInt(2, userId);
            ps.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    public static void updateHP(int userId, int hp) {
        String sql = "UPDATE user SET hp=? WHERE id=?";
        try (Connection conn = getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {
            ps.setInt(1, hp);
            ps.setInt(2, userId);
            ps.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    public static void insertExercise(int userId, String date, String content, int minutes) {
        String sql = "INSERT INTO exercise_log(user_id, date, content, minutes) VALUES(?,?,?,?)";
        try (Connection conn = getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {
            ps.setInt(1, userId);
            ps.setString(2, date);
            ps.setString(3, content);
            ps.setInt(4, minutes);
            ps.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    public static void insertCalorie(int userId, String date, String food, int kcal) {
        String sql = "INSERT INTO calorie_log(user_id, date, food, kcal) VALUES(?,?,?,?)";
        try (Connection conn = getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {
            ps.setInt(1, userId);
            ps.setString(2, date);
            ps.setString(3, food);
            ps.setInt(4, kcal);
            ps.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    public static void insertSleep(int userId, String date, double hours) {
        String sql = "INSERT INTO sleep_log(user_id, date, hours) VALUES(?,?,?)";
        try (Connection conn = getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {
            ps.setInt(1, userId);
            ps.setString(2, date);
            ps.setDouble(3, hours);
            ps.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
}}