package project;

import javax.swing.*;
import javax.swing.border.*;
import java.awt.*;
import java.awt.event.*;
import java.time.*;
import java.time.format.DateTimeFormatter;
import java.util.*;

public class MyCharacter {
    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> new SchedulerApp().setVisible(true));
    }
}

class SchedulerApp extends JFrame {
    private CardLayout cardLayout;
    private JPanel cards;
    private RegistrationPanel registrationPanel;
    private MainPanel mainPanel;
    private HealthcarePanel healthcarePanel;

    public SchedulerApp() {
        setTitle("Ïä§ÏºÄÏ§ÑÎü¨ / Ï∫êÎ¶≠ÌÑ∞");
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setSize(880, 640);
        setLocationRelativeTo(null);

        cardLayout = new CardLayout();
        cards = new JPanel(cardLayout);

        registrationPanel = new RegistrationPanel(this);
        mainPanel = new MainPanel();
        healthcarePanel = new HealthcarePanel();

        cards.add(registrationPanel, "register");
        cards.add(mainPanel, "main");
        cards.add(healthcarePanel, "healthcare");

        add(cards);
        cardLayout.show(cards, "register");

        // MainPanelÏùò ÌïòÎã® ÎÑ§ÎπÑ Î≤ÑÌäº Ïó∞Í≤∞
        mainPanel.getHealthcareButton().addActionListener(e -> {
            // Ìó¨Ïä§ÏºÄÏñ¥Î°ú Ïù¥ÎèôÌïòÎ©¥ÏÑú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Ï†ÑÎã¨
            healthcarePanel.setCharacterText(mainPanel.getNickname() + " " + mainPanel.getAvatarIcon());
            cardLayout.show(cards, "healthcare");
        });

        // HealthcarePanelÏùò Îí§Î°úÍ∞ÄÍ∏∞ Î≤ÑÌäº Ïó∞Í≤∞
        healthcarePanel.getBackButton().addActionListener(e ->
            cardLayout.show(cards, "main")
        );
    }

    public void showMain(String nickname, String avatarIcon) {
        mainPanel.setUserInfo(nickname, avatarIcon);
        cardLayout.show(cards, "main");
    }
}

class RegistrationPanel extends JPanel {
    private SchedulerApp parent;
    private JComboBox<String> avatarCombo;
    private JTextField nameField;

    public RegistrationPanel(SchedulerApp parent) {
        this.parent = parent;

        setLayout(new BorderLayout(10, 10));
        setBorder(new EmptyBorder(40, 80, 40, 80));

        JLabel title = new JLabel("Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±", SwingConstants.CENTER);
        title.setFont(new Font("SansSerif", Font.BOLD, 26));
        add(title, BorderLayout.NORTH);

        JPanel center = new JPanel(new BorderLayout(10, 10));
        JLabel preview = new JLabel("üåû", SwingConstants.CENTER);
        preview.setFont(new Font("SansSerif", Font.PLAIN, 48));
        preview.setBorder(new LineBorder(Color.LIGHT_GRAY, 1));
        preview.setPreferredSize(new Dimension(180, 180));
        center.add(preview, BorderLayout.WEST);

        JPanel form = new JPanel(new GridLayout(4, 1, 8, 8));
        form.setBorder(new EmptyBorder(10, 20, 10, 20));
        avatarCombo = new JComboBox<>(new String[] {"üåû Ìï¥Îãò", "üåô Îã¨Îãò", "‚≠ê Î≥ÑÎãò", "üê∂ Í∞ïÏïÑÏßÄ", "üê± Í≥†ÏñëÏù¥"});
        nameField = new JTextField();

        avatarCombo.addActionListener(e -> {
            String sel = (String) avatarCombo.getSelectedItem();
            preview.setText(sel.split(" ")[0]);
        });

        form.add(new JLabel("ÏïÑÎ∞îÌÉÄ ÏÑ†ÌÉù"));
        form.add(avatarCombo);
        form.add(new JLabel("ÎãâÎÑ§ÏûÑ ÏûÖÎ†•"));
        form.add(nameField);

        center.add(form, BorderLayout.CENTER);
        add(center, BorderLayout.CENTER);

        JButton createBtn = new JButton("Îì±Î°ù ÏôÑÎ£å");
        createBtn.setFont(new Font("SansSerif", Font.BOLD, 14));
        createBtn.addActionListener(e -> {
            String name = nameField.getText().trim();
            String avatar = (String) avatarCombo.getSelectedItem();
            if (name.isEmpty()) {
                JOptionPane.showMessageDialog(this, "ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                return;
            }
            parent.showMain(name, avatar);
        });
        add(createBtn, BorderLayout.SOUTH);
    }
}

class MainPanel extends JPanel {
    private String nickname = "ÏÇ¨Ïö©Ïûê";
    private String avatarIcon = "üåû";

    private JLabel avatarLabel;
    private JLabel nameLabel;
    private JProgressBar hpBar;
    private JLabel dateLabel;
    private JLabel timeLabel;
    private JComboBox<LocalDate> dateSelector;

    private DefaultListModel<String> scheduleModel;
    private JList<String> scheduleList;
    private Map<LocalDate, TreeMap<LocalTime, String>> scheduleStore = new HashMap<>();

    private JTextField timeInput;
    private JTextField taskInput;
    private JPanel regCard;

    private JButton healthcareBtn;
    
    public MainPanel() {
        setLayout(new BorderLayout(12, 12));
        setBorder(new EmptyBorder(12, 12, 12, 12));

        JPanel top = new JPanel(new BorderLayout(8, 8));
        top.setPreferredSize(new Dimension(0, 120));

        JPanel charCard = new JPanel(new BorderLayout());
        charCard.setBorder(new TitledBorder("Ï∫êÎ¶≠ÌÑ∞"));
        avatarLabel = new JLabel(avatarIcon, SwingConstants.CENTER);
        avatarLabel.setFont(new Font("SansSerif", Font.PLAIN, 48));
        nameLabel = new JLabel("ÎãâÎÑ§ÏûÑ: " + nickname, SwingConstants.CENTER);
        nameLabel.setFont(new Font("SansSerif", Font.BOLD, 14));
        charCard.add(avatarLabel, BorderLayout.CENTER);
        charCard.add(nameLabel, BorderLayout.SOUTH);
        charCard.setPreferredSize(new Dimension(220, 0));
        top.add(charCard, BorderLayout.WEST);

        JPanel centerCard = new JPanel(new BorderLayout(6, 6));
        centerCard.setBorder(new TitledBorder("ÎÇ†Ïßú Î∞è ÏãúÍ∞Ñ"));
        JPanel dtPanel = new JPanel(new GridLayout(2, 1));
        dateLabel = new JLabel("ÎÇ†Ïßú: " + LocalDate.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd")), SwingConstants.CENTER);
        dateLabel.setFont(new Font("SansSerif", Font.PLAIN, 16));
        timeLabel = new JLabel("ÏãúÍ∞Ñ: " + LocalTime.now().format(DateTimeFormatter.ofPattern("HH:mm:ss")), SwingConstants.CENTER);
        timeLabel.setFont(new Font("SansSerif", Font.PLAIN, 16));
        dtPanel.add(dateLabel);
        dtPanel.add(timeLabel);
        centerCard.add(dtPanel, BorderLayout.CENTER);

        LocalDate today = LocalDate.now();
        dateSelector = new JComboBox<>();
        for (int i = -30; i <= 30; i++) {
            dateSelector.addItem(today.plusDays(i));
        }
        dateSelector.setSelectedItem(today);
        dateSelector.addActionListener(e -> loadSchedulesForSelectedDate());
        JPanel selPanel = new JPanel(new FlowLayout(FlowLayout.CENTER));
        selPanel.add(new JLabel("ÎÇ†Ïßú ÏÑ†ÌÉù:"));
        selPanel.add(dateSelector);
        centerCard.add(selPanel, BorderLayout.SOUTH);

        top.add(centerCard, BorderLayout.CENTER);

        JPanel statusCard = new JPanel();
        statusCard.setLayout(new BoxLayout(statusCard, BoxLayout.Y_AXIS));
        statusCard.setBorder(new TitledBorder("ÏÉÅÌÉú"));
        hpBar = new JProgressBar(0, 100);
        hpBar.setValue(100);
        hpBar.setStringPainted(true);
        hpBar.setForeground(Color.RED);
        JLabel hpLabel = new JLabel("HP", SwingConstants.CENTER);
        hpLabel.setAlignmentX(Component.CENTER_ALIGNMENT);
        statusCard.add(hpLabel);
        statusCard.add(Box.createRigidArea(new Dimension(0, 6)));
        statusCard.add(hpBar);
        statusCard.setPreferredSize(new Dimension(220, 0));
        top.add(statusCard, BorderLayout.EAST);

        add(top, BorderLayout.NORTH);

        JPanel center = new JPanel(new BorderLayout(8, 8));
        center.setBorder(new EmptyBorder(4, 4, 4, 4));

        scheduleModel = new DefaultListModel<>();
        scheduleList = new JList<>(scheduleModel);
        scheduleList.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
        scheduleList.setFont(new Font("SansSerif", Font.PLAIN, 14));
        JScrollPane scroll = new JScrollPane(scheduleList);
        scroll.setBorder(new TitledBorder("ÏùºÏ†ï Î™©Î°ù"));
        center.add(scroll, BorderLayout.CENTER);

        JPanel actionPanel = new JPanel();
        actionPanel.setLayout(new BoxLayout(actionPanel, BoxLayout.Y_AXIS));
        actionPanel.setBorder(new EmptyBorder(6, 6, 6, 6));
        JButton completeBtn = new JButton("‚úÖ ÏôÑÎ£å");
        JButton failBtn = new JButton("‚ùå Ïã§Ìå®");
        JButton deleteBtn = new JButton("üóëÔ∏è ÏÇ≠Ï†ú");
        completeBtn.setAlignmentX(Component.CENTER_ALIGNMENT);
        failBtn.setAlignmentX(Component.CENTER_ALIGNMENT);
        deleteBtn.setAlignmentX(Component.CENTER_ALIGNMENT);
        actionPanel.add(Box.createVerticalGlue());
        actionPanel.add(completeBtn);
        actionPanel.add(Box.createRigidArea(new Dimension(0, 8)));
        actionPanel.add(failBtn);
        actionPanel.add(Box.createRigidArea(new Dimension(0, 8)));
        actionPanel.add(deleteBtn);
        actionPanel.add(Box.createVerticalGlue());
        center.add(actionPanel, BorderLayout.EAST);

        add(center, BorderLayout.CENTER);

        JPanel bottom = new JPanel(new BorderLayout(8, 8));

        regCard = new JPanel(new BorderLayout(6, 6));
        regCard.setBorder(new TitledBorder("ÏùºÏ†ï Îì±Î°ù"));
        regCard.setVisible(false);
        JPanel fields = new JPanel(new GridLayout(2, 2, 6, 6));
        fields.add(new JLabel("ÏãúÍ∞Ñ (HH:mm):"));
        timeInput = new JTextField();
        fields.add(timeInput);
        fields.add(new JLabel("ÎÇ¥Ïö©:"));
        taskInput = new JTextField();
        fields.add(taskInput);
        regCard.add(fields, BorderLayout.CENTER);
        JButton addBtn = new JButton("Îì±Î°ù");
        regCard.add(addBtn, BorderLayout.EAST);

        bottom.add(regCard, BorderLayout.CENTER);

        JPanel nav = new JPanel(new GridLayout(1, 3, 12, 12));
        nav.setBorder(new EmptyBorder(6, 6, 6, 6));
        healthcareBtn = new JButton("Ìó¨Ïä§ÏºÄÏñ¥");
        JButton schedulerBtn = new JButton("Ïä§ÏºÄÏ§ÑÎü¨");
        JButton shopBtn = new JButton("ÏÉÅÏ†ê");
        nav.add(healthcareBtn);
        nav.add(schedulerBtn);
        nav.add(shopBtn);
        bottom.add(nav, BorderLayout.SOUTH);

        add(bottom, BorderLayout.SOUTH);

        // ÏùºÏ†ï Îì±Î°ù Î≤ÑÌäº Ïù¥Î≤§Ìä∏
        addBtn.addActionListener(e -> {
            String timeStr = timeInput.getText().trim();
            String task = taskInput.getText().trim();
            LocalDate selDate = (LocalDate) dateSelector.getSelectedItem();
            
            if (timeStr.isEmpty() || task.isEmpty()) {
                JOptionPane.showMessageDialog(this, "ÏãúÍ∞ÑÍ≥º ÎÇ¥Ïö©ÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                return;
            }
            
            try {
                LocalTime time = LocalTime.parse(timeStr, DateTimeFormatter.ofPattern("HH:mm"));
                scheduleStore.computeIfAbsent(selDate, k -> new TreeMap<>()).put(time, task);
                loadSchedulesForSelectedDate();
                timeInput.setText("");
                taskInput.setText("");
                JOptionPane.showMessageDialog(this, "ÏùºÏ†ïÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.");
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "ÏãúÍ∞Ñ ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§. (Ïòà: 14:30)");
            }
        });

        // ÏôÑÎ£å Î≤ÑÌäº
        completeBtn.addActionListener(e -> {
            int idx = scheduleList.getSelectedIndex();
            if (idx >= 0) {
                JOptionPane.showMessageDialog(this, "ÏùºÏ†ïÏùÑ ÏôÑÎ£åÌñàÏäµÎãàÎã§! HP +10");
                hpBar.setValue(Math.min(100, hpBar.getValue() + 10));
            }
        });

        // Ïã§Ìå® Î≤ÑÌäº
        failBtn.addActionListener(e -> {
            int idx = scheduleList.getSelectedIndex();
            if (idx >= 0) {
                JOptionPane.showMessageDialog(this, "ÏùºÏ†ïÏùÑ Ïã§Ìå®ÌñàÏäµÎãàÎã§. HP -10");
                hpBar.setValue(Math.max(0, hpBar.getValue() - 10));
            }
        });

        // ÏÇ≠Ï†ú Î≤ÑÌäº
        deleteBtn.addActionListener(e -> {
            int idx = scheduleList.getSelectedIndex();
            if (idx >= 0) {
                String selected = scheduleModel.get(idx);
                String timeStr = selected.split(" - ")[0];
                LocalTime time = LocalTime.parse(timeStr, DateTimeFormatter.ofPattern("HH:mm"));
                LocalDate selDate = (LocalDate) dateSelector.getSelectedItem();
                
                TreeMap<LocalTime, String> map = scheduleStore.get(selDate);
                if (map != null) {
                    map.remove(time);
                    loadSchedulesForSelectedDate();
                    JOptionPane.showMessageDialog(this, "ÏùºÏ†ïÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
                }
            }
        });

        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäº Ïù¥Î≤§Ìä∏
        shopBtn.addActionListener(e -> JOptionPane.showMessageDialog(this, "ÏÉÅÏ†êÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§."));
        schedulerBtn.addActionListener(e -> regCard.setVisible(!regCard.isVisible()));

        // 1Ï¥à Îã®ÏúÑ ÏãúÍ∞Ñ Í∞±Ïã† ÌÉÄÏù¥Î®∏
        new javax.swing.Timer(1000, e -> {
            timeLabel.setText("ÏãúÍ∞Ñ: " + LocalTime.now().format(DateTimeFormatter.ofPattern("HH:mm:ss")));
            dateLabel.setText("ÎÇ†Ïßú: " + LocalDate.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd")));
        }).start();

        loadSchedulesForSelectedDate();
    }

    public void setUserInfo(String nickname, String avatarIcon) {
        this.nickname = nickname;
        this.avatarIcon = avatarIcon.split(" ")[0];
        avatarLabel.setText(this.avatarIcon);
        nameLabel.setText("ÎãâÎÑ§ÏûÑ: " + this.nickname);
    }

    private void loadSchedulesForSelectedDate() {
        LocalDate selectedDate = (LocalDate) dateSelector.getSelectedItem();
        scheduleModel.clear();
        TreeMap<LocalTime, String> map = scheduleStore.getOrDefault(selectedDate, new TreeMap<>());
        for (Map.Entry<LocalTime, String> e : map.entrySet()) {
            scheduleModel.addElement(e.getKey().format(DateTimeFormatter.ofPattern("HH:mm")) + " - " + e.getValue());
        }
    }

    public JButton getHealthcareButton() {
        return healthcareBtn;
    }

    public String getNickname() {
        return nickname;
    }

    public String getAvatarIcon() {
        return avatarIcon;
    }
}

