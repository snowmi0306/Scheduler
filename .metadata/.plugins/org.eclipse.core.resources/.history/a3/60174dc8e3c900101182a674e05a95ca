package project;

import javax.swing.*;
import javax.swing.border.*;
import java.awt.*;
import java.time.LocalDate;

class HealthcarePanel extends JPanel {
    private SchedulerApp parent;
    private MainPanel mainPanel;

    private JTabbedPane tabbedPane;

    // Food tab
    private JSpinner foodSpinner;
    private JButton foodSubmitBtn;

    // Exercise tab
    private JComboBox<String> exerciseCombo;
    private JSpinner exerciseMinutesSpinner;
    private JButton exerciseSubmitBtn;

    // Sleep tab
    private JSpinner sleepHoursSpinner;
    private JButton sleepSubmitBtn;

    // Body info tab
    private JSpinner weightSpinner;   // kg
    private JSpinner heightSpinner;   // cm
    private JSpinner ageSpinner;      // years
    private JButton bodyInfoSaveBtn;

    // Summary area
    private JTextArea summaryArea;
    private JButton backBtn;

    // 기본 신체 정보 (초기값 0)
    private static double weight = 0;
    private static double height = 0;
    private static int age = 0;

    public HealthcarePanel(SchedulerApp parent, MainPanel mainPanel) {
        this.parent = parent;
        this.mainPanel = mainPanel;

        setLayout(new BorderLayout(12, 12));
        setBorder(new EmptyBorder(12, 12, 12, 12));

        // 통일된 타이틀
        JLabel title = new JLabel("HealthcarePanel", SwingConstants.CENTER);
        title.setFont(new Font("SansSerif", Font.BOLD, 20));
        add(title, BorderLayout.NORTH);

        tabbedPane = new JTabbedPane();
        tabbedPane.addTab("신체 정보", createBodyInfoPanel());
        tabbedPane.addTab("음식", createFoodPanel());
        tabbedPane.addTab("운동", createExercisePanel());
        tabbedPane.addTab("수면", createSleepPanel());

        add(tabbedPane, BorderLayout.CENTER);
        add(createRightSummaryPanel(), BorderLayout.EAST);

        JPanel bottom = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        backBtn = new JButton("뒤로가기");
        bottom.add(backBtn);
        add(bottom, BorderLayout.SOUTH);

        // 버튼 액션
        foodSubmitBtn.addActionListener(e -> submitFood());
        exerciseSubmitBtn.addActionListener(e -> submitExercise());
        sleepSubmitBtn.addActionListener(e -> submitSleep());
        bodyInfoSaveBtn.addActionListener(e -> saveBodyInfo());
        backBtn.addActionListener(e -> parent.showCard("main"));

        refreshSummary();
    }

    private JPanel createBodyInfoPanel() {
        JPanel p = new JPanel(new GridBagLayout());
        GridBagConstraints c = new GridBagConstraints();
        c.insets = new Insets(8, 8, 8, 8);
        c.fill = GridBagConstraints.HORIZONTAL;

        // 체중 (기본값 0)
        c.gridx = 0; c.gridy = 0;
        p.add(new JLabel("체중 (kg)"), c);
        c.gridx = 1;
        weightSpinner = new JSpinner(new SpinnerNumberModel((int)weight, 0, 300, 1));
        weightSpinner.setToolTipText("체중을 kg 단위로 입력하세요 (기본값 0)");
        p.add(weightSpinner, c);

        // 키 (기본값 0)
        c.gridx = 0; c.gridy = 1;
        p.add(new JLabel("키 (cm)"), c);
        c.gridx = 1;
        heightSpinner = new JSpinner(new SpinnerNumberModel((int)height, 0, 250, 1));
        heightSpinner.setToolTipText("키를 cm 단위로 입력하세요 (기본값 0)");
        p.add(heightSpinner, c);

        // 나이 (기본값 0)
        c.gridx = 0; c.gridy = 2;
        p.add(new JLabel("나이 (년)"), c);
        c.gridx = 1;
        ageSpinner = new JSpinner(new SpinnerNumberModel(age, 0, 120, 1));
        ageSpinner.setToolTipText("나이를 입력하세요 (기본값 0)");
        p.add(ageSpinner, c);

        // 저장 버튼
        c.gridx = 0; c.gridy = 3; c.gridwidth = 2;
        bodyInfoSaveBtn = new JButton("저장");
        p.add(bodyInfoSaveBtn, c);

        return p;
    }

    private JPanel createFoodPanel() {
        JPanel p = new JPanel(new GridBagLayout());
        GridBagConstraints c = new GridBagConstraints();
        c.insets = new Insets(8, 8, 8, 8);
        c.fill = GridBagConstraints.HORIZONTAL;

        c.gridx = 0; c.gridy = 0;
        p.add(new JLabel("음식 칼로리 (kcal)"), c);

        c.gridx = 1;
        // 기본값 0
        foodSpinner = new JSpinner(new SpinnerNumberModel(0, 0, 10000, 10));
        foodSpinner.setToolTipText("섭취한 음식의 칼로리를 입력하세요 (기본값 0)");
        p.add(foodSpinner, c);

        c.gridx = 0; c.gridy = 1; c.gridwidth = 2;
        foodSubmitBtn = new JButton("입력");
        p.add(foodSubmitBtn, c);

        return p;
    }

    private JPanel createExercisePanel() {
        JPanel p = new JPanel(new GridBagLayout());
        GridBagConstraints c = new GridBagConstraints();
        c.insets = new Insets(8, 8, 8, 8);
        c.fill = GridBagConstraints.HORIZONTAL;

        c.gridx = 0; c.gridy = 0;
        p.add(new JLabel("운동 종류"), c);

        c.gridx = 1;
        String[] exercises = new String[] {
            "체조","빨래","걷기 (5.6km/시간)","볼링","설거지","에어로빅",
            "테니스(복식)","스케이팅 (6.4km/시간)","테니스(단식)","수영","등산","달리기 (9km/시간)"
        };
        exerciseCombo = new JComboBox<>(exercises);
        exerciseCombo.setToolTipText("운동 종류를 선택하세요");
        p.add(exerciseCombo, c);

        c.gridx = 0; c.gridy = 1;
        p.add(new JLabel("운동 시간 (분)"), c);

        c.gridx = 1;
        // 기본값 0분 허용
        exerciseMinutesSpinner = new JSpinner(new SpinnerNumberModel(0, 0, 24*60, 1));
        exerciseMinutesSpinner.setToolTipText("운동 시간을 분 단위로 입력하세요 (기본값 0)");
        p.add(exerciseMinutesSpinner, c);

        c.gridx = 0; c.gridy = 2; c.gridwidth = 2;
        exerciseSubmitBtn = new JButton("입력");
        p.add(exerciseSubmitBtn, c);

        return p;
    }

    private JPanel createSleepPanel() {
        JPanel p = new JPanel(new GridBagLayout());
        GridBagConstraints c = new GridBagConstraints();
        c.insets = new Insets(8, 8, 8, 8);
        c.fill = GridBagConstraints.HORIZONTAL;

        c.gridx = 0; c.gridy = 0;
        p.add(new JLabel("수면 시간 (시간)"), c);

        c.gridx = 1;
        // 기본값 0시간
        sleepHoursSpinner = new JSpinner(new SpinnerNumberModel(0, 0, 24, 1));
        sleepHoursSpinner.setToolTipText("수면 시간을 시간 단위로 입력하세요 (기본값 0)");
        p.add(sleepHoursSpinner, c);

        c.gridx = 0; c.gridy = 1; c.gridwidth = 2;
        sleepSubmitBtn = new JButton("입력");
        p.add(sleepSubmitBtn, c);

        return p;
    }

    private JPanel createRightSummaryPanel() {
        JPanel panel = new JPanel(new BorderLayout(8, 8));
        panel.setPreferredSize(new Dimension(300, 0));
        panel.setBorder(new TitledBorder("오늘 요약"));

        summaryArea = new JTextArea();
        summaryArea.setEditable(false);
        summaryArea.setLineWrap(true);
        summaryArea.setWrapStyleWord(true);
        summaryArea.setFont(new Font("SansSerif", Font.PLAIN, 13));
        panel.add(new JScrollPane(summaryArea), BorderLayout.CENTER);

        JButton refreshBtn = new JButton("새로고침");
        refreshBtn.addActionListener(e -> refreshSummary());
        JPanel bottom = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        bottom.add(refreshBtn);
        panel.add(bottom, BorderLayout.SOUTH);

        return panel;
    }

    private void saveBodyInfo() {
        // 스피너 값 읽어서 정적 필드에 저장 (0 허용)
        weight = ((Number) weightSpinner.getValue()).doubleValue();
        height = ((Number) heightSpinner.getValue()).doubleValue();
        age = ((Number) ageSpinner.getValue()).intValue();

        JOptionPane.showMessageDialog(this, "신체 정보가 저장되었습니다.\n체중: " + (int)weight + " kg, 키: " + (int)height + " cm, 나이: " + age + " 세");
        refreshSummary();
    }

    private void submitFood() {
        int kcal = (Integer) foodSpinner.getValue();
        mainPanel.addFoodCalories(LocalDate.now(), kcal);
        JOptionPane.showMessageDialog(this, "음식 입력 완료: " + kcal + " kcal");
        refreshSummary();
    }

    private void submitExercise() {
        String type = (String) exerciseCombo.getSelectedItem();
        int minutes = (Integer) exerciseMinutesSpinner.getValue();

        int perHour;
        switch (type) {
            case "체조": perHour = 180; break;
            case "빨래": perHour = 180; break;
            case "걷기 (5.6km/시간)": perHour = (240 + 300) / 2; break;
            case "볼링": perHour = (240 + 300) / 2; break;
            case "설거지": perHour = 270; break;
            case "에어로빅": perHour = (300 + 360) / 2; break;
            case "테니스(복식)": perHour = (300 + 420) / 2; break;
            case "스케이팅 (6.4km/시간)": perHour = (360 + 480) / 2; break;
            case "테니스(단식)": perHour = (420 + 600) / 2; break;
            case "수영": perHour = 720; break;
            case "등산": perHour = 780; break;
            case "달리기 (9km/시간)": perHour = (600 + 660) / 2; break;
            default: perHour = 0; break;
        }

        int kcal = perHour * minutes / 60;
        mainPanel.addExerciseCalories(LocalDate.now(), kcal);
        JOptionPane.showMessageDialog(this, type + " " + minutes + "분 입력 완료: " + kcal + " kcal (기준 " + perHour + " kcal/시간)");
        refreshSummary();
    }

    private void submitSleep() {
        int hours = (Integer) sleepHoursSpinner.getValue();
        mainPanel.addSleepHours(LocalDate.now(), hours);
        JOptionPane.showMessageDialog(this, "수면 입력 완료: " + hours + " 시간");
        refreshSummary();
    }

    private void refreshSummary() {
        LocalDate today = LocalDate.now();
        int food = mainPanel.getFoodCaloriesForDate(today);
        int exercise = mainPanel.getExerciseCaloriesForDate(today);
        int sleep = mainPanel.getSleepHoursForDate(today);
        StringBuilder sb = new StringBuilder();
        sb.append("날짜: ").append(today).append("\n\n");
        sb.append("음식: ").append(food).append(" kcal\n");
        sb.append("운동: ").append(exercise).append(" kcal\n");
        sb.append("수면: ").append(sleep).append(" 시간\n\n");

        sb.append("신체 정보:\n");
        sb.append("체중: ").append((int)weight).append(" kg\n");
        sb.append("키: ").append((int)height).append(" cm\n");
        sb.append("나이: ").append(age).append(" 세\n\n");

        boolean isMale = mainPanel.getAvatarIcon().startsWith("남자");
        int bmr = MainPanel.calculateBMR(isMale, HealthcarePanel.getWeight(), HealthcarePanel.getUserHeight(), HealthcarePanel.getAge());
        sb.append("기초대사량(BMR): ").append(bmr).append(" kcal\n");
        sb.append("운동으로 추가된 허용 칼로리: ").append(exercise).append(" kcal\n");
        sb.append("총 허용 칼로리: ").append(bmr + exercise).append(" kcal\n");

        summaryArea.setText(sb.toString());
    }

    public JButton getBackButton() { return backBtn; }

    public void setCharacterText(String text) {
        // 우측 요약에 닉네임 표시 (기존 요약 위에 추가)
        summaryArea.setText("사용자: " + text + "\n\n" + summaryArea.getText());
    }

    // 기본 신체 정보 getter
    public static double getWeight() { return weight; }
    public static double getUserHeight() { return height; }
    public static int getAge() { return age; }
}