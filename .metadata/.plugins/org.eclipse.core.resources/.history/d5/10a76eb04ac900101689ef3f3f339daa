package project;

import java.sql.*;
import java.nio.file.*;
import java.io.*;

public class DBManager {
    private static final String DB_URL = "jdbc:sqlite:health_scheduler.db";

    // 드라이버 로드 및 DB 초기화
    static {
        try {
            Class.forName("org.sqlite.JDBC"); // SQLite JDBC 드라이버 로드
            System.out.println("SQLite JDBC Driver Loaded");
            initDatabase(); // 프로그램 시작 시 DB 초기화
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    // DB 연결 반환
    public static Connection getConnection() throws SQLException {
        return DriverManager.getConnection(DB_URL);
    }

    // health_scheduler.sql 파일을 읽어 테이블 생성
    private static void initDatabase() {
        try (Connection conn = getConnection();
             Statement stmt = conn.createStatement()) {

            // health_scheduler.sql 파일 읽기
            if (Files.exists(Paths.get("health_scheduler.sql"))) {
                String sql = Files.readString(Paths.get("health_scheduler.sql"));
                stmt.executeUpdate(sql);
                System.out.println("Database initialized with health_scheduler.sql");
            } else {
                System.out.println("health_scheduler.sql 파일을 찾을 수 없습니다.");
            }

        } catch (Exception e) {
            System.err.println("DB 초기화 실패: " + e.getMessage());
        }
    }

    // 유저 등록
    public static int insertUser(String nickname, String character) {
        String sql = "INSERT INTO user(nickname, character, hp, coin) VALUES(?,?,100,0)";
        try (Connection conn = getConnection();
             PreparedStatement ps = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {
            ps.setString(1, nickname);
            ps.setString(2, character);
            ps.executeUpdate();
            ResultSet rs = ps.getGeneratedKeys();
            if (rs.next()) return rs.getInt(1);
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return -1;
    }

    // 몸무게 업데이트
    public static void updateWeight(int userId, double weight) {
        String sql = "UPDATE user SET weight=? WHERE id=?";
        try (Connection conn = getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {
            ps.setDouble(1, weight);
            ps.setInt(2, userId);
            ps.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    // HP 업데이트
    public static void updateHP(int userId, int hp) {
        String sql = "UPDATE user SET hp=? WHERE id=?";
        try (Connection conn = getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {
            ps.setInt(1, hp);
            ps.setInt(2, userId);
            ps.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    // 운동 기록 추가
    public static void insertExercise(int userId, String date, String content, int minutes) {
        String sql = "INSERT INTO exercise_log(user_id,date,content,minutes) VALUES(?,?,?,?)";
        try (Connection conn = getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {
            ps.setInt(1, userId);
            ps.setString(2, date);
            ps.setString(3, content);
            ps.setInt(4, minutes);
            ps.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    // 칼로리 기록 추가
    public static void insertCalorie(int userId, String date, String food, int kcal) {
        String sql = "INSERT INTO calorie_log(user_id,date,food,kcal) VALUES(?,?,?,?)";
        try (Connection conn = getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {
            ps.setInt(1, userId);
            ps.setString(2, date);
            ps.setString(3, food);
            ps.setInt(4, kcal);
            ps.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    // 수면 기록 추가
    public static void insertSleep(int userId, String date, double hours) {
        String sql = "INSERT INTO sleep_log(user_id,date,hours) VALUES(?,?,?)";
        try (Connection conn = getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {
            ps.setInt(1, userId);
            ps.setString(2, date);
            ps.setDouble(3, hours);
            ps.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
}