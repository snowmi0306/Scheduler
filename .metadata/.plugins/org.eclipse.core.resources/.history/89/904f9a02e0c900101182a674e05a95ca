package project;

import javax.swing.*;
import javax.swing.border.*;
import java.awt.*;
import java.time.LocalDate;

class HealthcarePanel extends JPanel {
    private SchedulerApp parent;
    private MainPanel mainPanel;

    private JTabbedPane tabbedPane;

    private JSpinner foodSpinner;
    private JButton foodSubmitBtn;

    private JComboBox<String> exerciseCombo;
    private JSpinner exerciseMinutesSpinner;
    private JButton exerciseSubmitBtn;

    private JSpinner sleepHoursSpinner;
    private JButton sleepSubmitBtn;

    private JTextArea summaryArea;
    private JButton backBtn;

    private static double weight = 70;
    private static double height = 175;
    private static int age = 25;

    public HealthcarePanel(SchedulerApp parent, MainPanel mainPanel) {
        this.parent = parent;
        this.mainPanel = mainPanel;

        setLayout(new BorderLayout(12, 12));
        setBorder(new EmptyBorder(12, 12, 12, 12));

        JLabel title = new JLabel("헬스케어 입력", SwingConstants.CENTER);
        title.setFont(new Font("SansSerif", Font.BOLD, 20));
        add(title, BorderLayout.NORTH);

        tabbedPane = new JTabbedPane();
        tabbedPane.addTab("음식", createFoodPanel());
        tabbedPane.addTab("운동", createExercisePanel());
        tabbedPane.addTab("수면", createSleepPanel());

        add(tabbedPane, BorderLayout.CENTER);
        add(createRightSummaryPanel(), BorderLayout.EAST);

        JPanel bottom = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        backBtn = new JButton("뒤로가기");
        bottom.add(backBtn);
        add(bottom, BorderLayout.SOUTH);

        foodSubmitBtn.addActionListener(e -> submitFood());
        exerciseSubmitBtn.addActionListener(e -> submitExercise());
        sleepSubmitBtn.addActionListener(e -> submitSleep());

        // 카드 전환은 public API를 통해 호출
        backBtn.addActionListener(e -> parent.showCard("main"));

        refreshSummary();
    }

    private JPanel createFoodPanel() {
        JPanel p = new JPanel(new GridBagLayout());
        GridBagConstraints c = new GridBagConstraints();
        c.insets = new Insets(8, 8, 8, 8);
        c.fill = GridBagConstraints.HORIZONTAL;

        c.gridx = 0; c.gridy = 0;
        p.add(new JLabel("음식 칼로리 (kcal)"), c);

        c.gridx = 1;
        foodSpinner = new JSpinner(new SpinnerNumberModel(200, 0, 10000, 10));
        p.add(foodSpinner, c);

        c.gridx = 0; c.gridy = 1; c.gridwidth = 2;
        foodSubmitBtn = new JButton("입력");
        p.add(foodSubmitBtn, c);

        return p;
    }

    private JPanel createExercisePanel() {
        JPanel p = new JPanel(new GridBagLayout());
        GridBagConstraints c = new GridBagConstraints();
        c.insets = new Insets(8, 8, 8, 8);
        c.fill = GridBagConstraints.HORIZONTAL;

        c.gridx = 0; c.gridy = 0;
        p.add(new JLabel("운동 종류"), c);

        c.gridx = 1;
        String[] exercises = new String[] {
            "체조","빨래","걷기 (5.6km/시간)","볼링","설거지","에어로빅",
            "테니스(복식)","스케이팅 (6.4km/시간)","테니스(단식)","수영","등산","달리기 (9km/시간)"
        };
        exerciseCombo = new JComboBox<>(exercises);
        p.add(exerciseCombo, c);

        c.gridx = 0; c.gridy = 1;
        p.add(new JLabel("운동 시간 (분)"), c);

        c.gridx = 1;
        exerciseMinutesSpinner = new JSpinner(new SpinnerNumberModel(30, 1, 24*60, 1));
        p.add(exerciseMinutesSpinner, c);

        c.gridx = 0; c.gridy = 2; c.gridwidth = 2;
        exerciseSubmitBtn = new JButton("입력");
        p.add(exerciseSubmitBtn, c);

        return p;
    }

    private JPanel createSleepPanel() {
        JPanel p = new JPanel(new GridBagLayout());
        GridBagConstraints c = new GridBagConstraints();
        c.insets = new Insets(8, 8, 8, 8);
        c.fill = GridBagConstraints.HORIZONTAL;

        c.gridx = 0; c.gridy = 0;
        p.add(new JLabel("수면 시간 (시간)"), c);

        c.gridx = 1;
        sleepHoursSpinner = new JSpinner(new SpinnerNumberModel(7, 0, 24, 1));
        p.add(sleepHoursSpinner, c);

        c.gridx = 0; c.gridy = 1; c.gridwidth = 2;
        sleepSubmitBtn = new JButton("입력");
        p.add(sleepSubmitBtn, c);

        return p;
    }

    private JPanel createRightSummaryPanel() {
        JPanel panel = new JPanel(new BorderLayout(8, 8));
        panel.setPreferredSize(new Dimension(300, 0));
        panel.setBorder(new TitledBorder("오늘 요약"));

        summaryArea = new JTextArea();
        summaryArea.setEditable(false);
        summaryArea.setLineWrap(true);
        summaryArea.setWrapStyleWord(true);
        summaryArea.setFont(new Font("SansSerif", Font.PLAIN, 13));
        panel.add(new JScrollPane(summaryArea), BorderLayout.CENTER);

        JButton refreshBtn = new JButton("새로고침");
        refreshBtn.addActionListener(e -> refreshSummary());
        JPanel bottom = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        bottom.add(refreshBtn);
        panel.add(bottom, BorderLayout.SOUTH);

        return panel;
    }

    private void submitFood() {
        int kcal = (Integer) foodSpinner.getValue();
        mainPanel.addFoodCalories(LocalDate.now(), kcal);
        JOptionPane.showMessageDialog(this, "음식 입력 완료: " + kcal + " kcal");
        refreshSummary();
    }

    private void submitExercise() {
        String type = (String) exerciseCombo.getSelectedItem();
        int minutes = (Integer) exerciseMinutesSpinner.getValue();

        int perHour;
        switch (type) {
            case "체조": perHour = 180; break;
            case "빨래": perHour = 180; break;
            case "걷기 (5.6km/시간)": perHour = (240+300)/2; break;
            case "볼링": perHour = (240+300)/2; break;
            case "설거지": perHour = 270; break;
            case "에어로빅": perHour = (300+360)/2; break;
            case "테니스(복식)": perHour = (300+420)/2; break;
            case "스케이팅 (6.4km/시간)": perHour = (360+480)/2; break;
            case "테니스(단식)": perHour = (420+600)/2; break;
            case "수영": perHour = 720; break;
            case "등산": perHour = 780; break;
            case "달리기 (9km/시간)": perHour = (600+660)/2; break;
            default: perHour = 0; break;
        }

        int kcal = perHour * minutes / 60;
        mainPanel.addExerciseCalories(LocalDate.now(), kcal);
        JOptionPane.showMessageDialog(this, type + " " + minutes + "분 입력 완료: " + kcal + " kcal");
        refreshSummary();
    }

    private void submitSleep() {
        int hours = (Integer) sleepHoursSpinner.getValue();
        mainPanel.addSleepHours(LocalDate.now(), hours);
        JOptionPane.showMessageDialog(this, "수면 입력 완료: " + hours + " 시간");
        refreshSummary();
    }

    private void refreshSummary() {
        LocalDate today = LocalDate.now();

        // 캡슐화된 getter 사용 (MainPanel에 public으로 구현되어 있어야 함)
        int food = mainPanel.getFoodCaloriesForDate(today);
        int exercise = mainPanel.getExerciseCaloriesForDate(today);
        int sleep = mainPanel.getSleepHoursForDate(today);

        StringBuilder sb = new StringBuilder();
        sb.append("날짜: ").append(today).append("\n\n");
        sb.append("음식: ").append(food).append(" kcal\n");
        sb.append("운동: ").append(exercise).append(" kcal\n");
        sb.append("수면: ").append(sleep).append(" 시간\n\n");

        boolean isMale = mainPanel.getAvatarIcon().startsWith("남자");
        int bmr = MainPanel.calculateBMR(isMale, HealthcarePanel.getWeight(), HealthcarePanel.getUserHeight(), HealthcarePanel.getAge());
        sb.append("기초대사량(BMR): ").append(bmr).append(" kcal\n");
        sb.append("총 허용 칼로리: ").append(bmr + exercise).append(" kcal\n");

        summaryArea.setText(sb.toString());
    }

    public JButton getBackButton() { return backBtn; }

    public void setCharacterText(String text) {
        summaryArea.setText("사용자: " + text + "\n\n" + summaryArea.getText());
    }

    public static double getWeight() { return weight; }
    public static double getUserHeight() { return height; }
    public static int getAge() { return age; }
}